<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visa Application Form</title>
  <!-- jsPDF va jspdf-autotable kutubxonalarini qo'shamiz -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f5f5f5; }
    .container { max-width: 800px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
    h1 { text-align: center; color: #333; margin-bottom: 30px; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input[type="text"], input[type="date"], select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    .row { display: flex; gap: 20px; }
    .col { flex: 1; }
    .buttons { display: flex; justify-content: center; gap: 20px; margin-top: 30px; }
    button { background-color: #4CAF50; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
    button:hover { background-color: #45a049; }
    #exportBtn { background-color: #2196F3; }
    #exportBtn:hover { background-color: #0b7dda; }
    #saveBtn { background-color: #ff9800; }
    #saveBtn:hover { background-color: #e68900; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Visa Application Form</h1>
    <form id="visaForm">
      <div class="form-group">
        <label for="surname">1. Surname, Name</label>
        <input type="text" id="surname" name="surname" required>
      </div>
      <div class="form-group">
        <label for="gender">2. Gender</label>
        <select id="gender" name="gender" required>
          <option value="">Select Gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
        </select>
      </div>
      <div class="row">
        <div class="col">
          <div class="form-group">
            <label for="birthDate">3. Date of Birth</label>
            <input type="date" id="birthDate" name="birthDate" required>
          </div>
        </div>
        <div class="col">
          <div class="form-group">
            <label for="birthPlace">Place of Birth</label>
            <input type="text" id="birthPlace" name="birthPlace" required>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="citizenship">4. Citizenship</label>
        <input type="text" id="citizenship" name="citizenship" required>
      </div>
      <div class="form-group">
        <label for="nationality">5. Nationality</label>
        <input type="text" id="nationality" name="nationality" required>
      </div>
      <div class="row">
        <div class="col">
          <div class="form-group">
            <label for="passportNumber">6. Passport №</label>
            <input type="text" id="passportNumber" name="passportNumber" required>
          </div>
        </div>
        <div class="col">
          <div class="form-group">
            <label for="issueDate">Date of Issue</label>
            <input type="date" id="issueDate" name="issueDate" required>
          </div>
        </div>
        <div class="col">
          <div class="form-group">
            <label for="expiryDate">Date of Expiry</label>
            <input type="date" id="expiryDate" name="expiryDate" required>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="position">7. Current Position, Place of Work/Study</label>
        <input type="text" id="position" name="position" required>
      </div>
      <div class="form-group">
        <label for="address">8. Home Address</label>
        <textarea id="address" name="address" rows="3" required></textarea>
      </div>
      <!-- Modified: visaPlace input replaced with select -->
      <div class="form-group">
        <label for="visaPlace">9. Place of Obtaining a Visa</label>
        <select id="visaPlace" name="visaPlace" required>
          <option value="">Select City</option>
          <option value="Turkmenistan Ashgabat city">Turkmenistan Ashgabat city</option>
          <option value="Turkmenistan Turkmenbashy city">Turkmenistan Turkmenbashy city</option>
        </select>
      </div>
      <div class="row">
        <div class="col">
          <div class="form-group">
            <label for="startDate">10. Start Date of Stay</label>
            <input type="date" id="startDate" name="startDate" required>
          </div>
        </div>
        <div class="col">
          <div class="form-group">
            <label for="endDate">End Date of Stay</label>
            <input type="date" id="endDate" name="endDate" required>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="entries">11. Number of Entries</label>
        <select id="entries" name="entries" required>
          <option value="">Select Number</option>
          <option value="single">Single</option>
          <option value="multiple">Multiple</option>
        </select>
      </div>
      <div class="form-group">
        <label for="purpose">12. Aim of Visit</label>
        <select id="purpose" name="purpose" required>
          <option value="">Select Purpose</option>
          <option value="Study">Study</option>
          <option value="Work">Work</option>
          <option value="Tourism">Tourism</option>
          <option value="Business">Business</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>13. Type of Vehicle of Entry and Exit</label>
        <div>
          <label><input type="checkbox" name="vehicle" value="Car"> Car</label>
          <label><input type="checkbox" name="vehicle" value="Train"> Train</label>
          <label><input type="checkbox" name="vehicle" value="Airplane"> Airplane</label>
          <label><input type="checkbox" name="vehicle" value="Ship"> Ship</label>
        </div>
      </div>
      <div class="form-group">
        <label for="route">14. The Route of Travel and Points to Visit</label>
        <textarea id="route" name="route" rows="3" required></textarea>
      </div>
      <div class="form-group">
        <label for="passportPhoto">15. Passport Photo</label>
        <input type="file" id="passportPhoto" name="passportPhoto" accept="image/*" required>
        <div id="photoPreview" style="margin-top:10px;">
          <img id="previewImg" src="" alt="Passport Preview" style="width:100%; max-height:300px; object-fit:contain; display:none; border: 1px solid #ccc; border-radius: 4px;">
        </div>
      </div>
      <div class="buttons">
        <button type="button" id="saveBtn">Save Form</button>
        <button type="button" id="exportBtn">Export as PDF</button>
        <button type="reset">Reset</button>
      </div>
    </form>
  </div>
  <script>
    // Matnni avval katta harf, keyin kichik harf qilish uchun funksiya
    function toTitleCase(str) {
      if (!str) return '';
      return str.toLowerCase().replace(/(^|\s)\w/g, letter => letter.toUpperCase());
    }

    // Forma ma'lumotlarini saqlash
    function saveForm() {
      try {
        const formData = {
          surname: document.getElementById('surname').value,
          gender: document.getElementById('gender').value,
          birthDate: document.getElementById('birthDate').value,
          birthPlace: document.getElementById('birthPlace').value,
          citizenship: document.getElementById('citizenship').value,
          nationality: document.getElementById('nationality').value,
          passportNumber: document.getElementById('passportNumber').value,
          issueDate: document.getElementById('issueDate').value,
          expiryDate: document.getElementById('expiryDate').value,
          position: document.getElementById('position').value,
          address: document.getElementById('address').value,
          visaPlace: document.getElementById('visaPlace').value, // Select elementdan qiymat olish
          startDate: document.getElementById('startDate').value,
          endDate: document.getElementById('endDate').value,
          entries: document.getElementById('entries').value,
          purpose: document.getElementById('purpose').value,
          vehicles: Array.from(document.querySelectorAll('input[name="vehicle"]:checked')).map(cb => cb.value),
          route: document.getElementById('route').value
        };
        localStorage.setItem('visaFormData', JSON.stringify(formData));
        alert('Forma muvaffaqiyatli saqlandi!');
      } catch (error) {
        console.error('Saqlashda xatolik:', error);
        alert('Forma saqlashda xatolik yuz berdi! Iltimos, brauzer sozlamalarini tekshiring (masalan, maxfiy rejimda emasligiga ishonch hosil qiling).');
      }
    }

    // Saqlangan ma'lumotlarni yuklash
    function loadForm() {
      try {
        const savedData = localStorage.getItem('visaFormData');
        if (savedData) {
          const formData = JSON.parse(savedData);
          document.getElementById('surname').value = formData.surname || '';
          document.getElementById('gender').value = formData.gender || '';
          document.getElementById('birthDate').value = formData.birthDate || '';
          document.getElementById('birthPlace').value = formData.birthPlace || '';
          document.getElementById('citizenship').value = formData.citizenship || '';
          document.getElementById('nationality').value = formData.nationality || '';
          document.getElementById('passportNumber').value = formData.passportNumber || '';
          document.getElementById('issueDate').value = formData.issueDate || '';
          document.getElementById('expiryDate').value = formData.expiryDate || '';
          document.getElementById('position').value = formData.position || '';
          document.getElementById('address').value = formData.address || '';
          document.getElementById('visaPlace').value = formData.visaPlace || ''; // Select elementga qiymat o'rnatish
          document.getElementById('startDate').value = formData.startDate || '';
          document.getElementById('endDate').value = formData.endDate || '';
          document.getElementById('entries').value = formData.entries || '';
          document.getElementById('purpose').value = formData.purpose || '';
          document.getElementById('route').value = formData.route || '';
          const vehicleCheckboxes = document.querySelectorAll('input[name="vehicle"]');
          vehicleCheckboxes.forEach(checkbox => {
            checkbox.checked = formData.vehicles.includes(checkbox.value);
          });
        }
      } catch (error) {
        console.error('Ma\'lumotlarni yuklashda xatolik:', error);
        alert('Saqlangan ma\'lumotlarni yuklashda xatolik yuz berdi!');
      }
    }

    // Sahifa yuklanganda ma'lumotlarni qayta tiklash
    window.onload = loadForm;

    // "Save Form" tugmasi
    document.getElementById('saveBtn').addEventListener('click', saveForm);

    // "Export as PDF" tugmasi
    document.getElementById('exportBtn').addEventListener('click', function () {
      try {
        // Forma ma'lumotlarini yig'ish
        const formData = {
          surname: document.getElementById('surname').value,
          gender: document.getElementById('gender').value,
          birthDate: document.getElementById('birthDate').value,
          birthPlace: document.getElementById('birthPlace').value,
          citizenship: document.getElementById('citizenship').value,
          nationality: document.getElementById('nationality').value,
          passportNumber: document.getElementById('passportNumber').value,
          issueDate: document.getElementById('issueDate').value,
          expiryDate: document.getElementById('expiryDate').value,
          position: document.getElementById('position').value,
          address: document.getElementById('address').value,
          visaPlace: document.getElementById('visaPlace').value, // Select elementdan qiymat olish
          startDate: document.getElementById('startDate').value,
          endDate: document.getElementById('endDate').value,
          entries: document.getElementById('entries').value,
          purpose: document.getElementById('purpose').value,
          vehicles: Array.from(document.querySelectorAll('input[name="vehicle"]:checked')).map(cb => cb.value).join(', '),
          route: document.getElementById('route').value
        };

        // Sana formatini o'zgartirish
        const formatDate = (dateString) => {
          if (!dateString) return '';
          const date = new Date(dateString);
          return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
        };

        // jsPDF va autoTable dan foydalanish
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Sarlavha
        doc.setFont("times", "normal");
        doc.setFontSize(16);
        doc.text("Visa application", 105, 10, { align: "center" });

        // Jadval ma'lumotlari (raqamlar chapda, ikki ustunli tuzilish)
        const tableData = [
          ["1", toTitleCase("Surname, name"), toTitleCase(formData.surname || '-')],
          ["2", toTitleCase("Gender"), toTitleCase(formData.gender || '-')],
          ["3", toTitleCase("Date and place of birth"), toTitleCase(`${formatDate(formData.birthDate)}, ${formData.birthPlace}` || '-')],
          ["4", toTitleCase("Citizenship"), toTitleCase(formData.citizenship || '-')],
          ["5", toTitleCase("Nationality"), toTitleCase(formData.nationality || '-')],
          ["6", toTitleCase("Passport №"), toTitleCase(formData.passportNumber || '-')],
          ["", toTitleCase("Date of issue"), toTitleCase(`${formatDate(formData.issueDate)} - ${formatDate(formData.expiryDate)}` || '-')],
          ["7", toTitleCase("Current position, place of work/study"), toTitleCase(formData.position || '-')],
          ["8", toTitleCase("Home address"), toTitleCase(formData.address || '-')],
          ["9", toTitleCase("Place of obtaining a visa"), toTitleCase(formData.visaPlace || '-')],
          ["10", toTitleCase("Period of stay (exact dates)"), toTitleCase(`${formatDate(formData.startDate)} - ${formatDate(formData.endDate)}` || '-')],
          ["11", toTitleCase("Number of entries"), toTitleCase(formData.entries === 'single' ? 'Single' : 'Multiple' || '-')],
          ["12", toTitleCase("Aim of visit"), toTitleCase(formData.purpose || '-')],
          ["13", toTitleCase("Type of vehicle of entry and exit"), toTitleCase(formData.vehicles || '-')],
          ["14", toTitleCase("The route of travel and points to visit in Kazakhstan"), toTitleCase(formData.route || '-')]
        ];

        // Jadvalni chizish
        doc.autoTable({
          startY: 20,
          body: tableData,
          styles: {
            font: "times", // Shriftni Times New Roman qilib sozlash
            fontSize: 12, // Shrift o'lchami 12 pt
            cellPadding: 1, // Katak ichidagi bo'shliqni kamaytirish
            lineColor: [0, 0, 0], // Chiziqlar rangi qora
            lineWidth: 0.1, // Chiziqlar nozik
            halign: 'left',
            valign: 'middle', // Matnni vertikal markazda joylashtirish
            fillColor: [255, 255, 255], // Kataklarning fon rangi oq
            fontStyle: 'normal' // Qalinlikni olib tashlash
          },
          columnStyles: {
            0: { cellWidth: 10, halign: 'center' }, // Raqamlar uchun kichik ustun
            1: { cellWidth: 70, halign: 'left', fontStyle: 'normal' }, // Sarlavha ustuni (qalinlik yo'q)
            2: { cellWidth: 100, halign: 'left', fontStyle: 'normal' } // Ma'lumotlar ustuni (qalinlik yo'q)
          },
          margin: { left: 15, right: 15 },
          theme: 'grid', // To'liq chiziqli jadval
          headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], fontStyle: 'normal' },
          rowHeight: 5 // Qator balandligini kamaytirish
        });

        // Jadvaldan keyingi pozitsiyani aniqlash
        const finalY = doc.lastAutoTable.finalY || 20;

        // Rasmni PDF ga qo'shish
        const passportPhotoInput = document.getElementById('passportPhoto');
        const previewImg = document.getElementById('previewImg');

        if (passportPhotoInput.files && passportPhotoInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const imgData = e.target.result; // Rasmning base64 formatidagi ma'lumotlari
            const imgWidth = 180; // Jadvalning umumiy kengligi (10 + 70 + 100 = 180 mm)
            const marginLeft = 15; // Jadvalning chap chet margini
            const imgHeight = imgWidth * (180 / 297); // Rasmning balandligi (nisbat 180/297)

            // Rasmni jadval bilan bir xil kenglikda va chapdan bir xil masofada joylashtirish
            doc.addImage(imgData, 'JPEG', marginLeft, finalY + 5, imgWidth, imgHeight);

            // PDF ni saqlash
            const now = new Date();
            const fileName = `Visa_Application_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.pdf`;
            doc.save(fileName);
          };
          reader.readAsDataURL(passportPhotoInput.files[0]);
        } else if (previewImg.src) {
          const imgWidth = 180;
          const marginLeft = 15;
          const imgHeight = imgWidth * (180 / 297);

          doc.addImage(previewImg.src, 'JPEG', marginLeft, finalY + 5, imgWidth, imgHeight);

          const now = new Date();
          const fileName = `Visa_Application_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.pdf`;
          doc.save(fileName);
        } else {
          const now = new Date();
          const fileName = `Visa_Application_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.pdf`;
          doc.save(fileName);
        }
      } catch (error) {
        console.error('PDF eksportda xatolik:', error);
        alert('PDF eksport qilishda xatolik yuz berdi! Internet aloqasini tekshiring.');
      }
    });

    // Rasmni oldindan ko'rish funksiyasi
    document.getElementById('passportPhoto').addEventListener('change', function (e) { // Changed from 'click' to 'change'
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const previewImg = document.getElementById('previewImg');
          previewImg.src = e.target.result;
          previewImg.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });
  </script>
</body>
  </html>
